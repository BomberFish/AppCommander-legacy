//
//  Unsandbox.swift
//  Caché
//
//  Created by Hariz Shirazi on 2023-03-02.
//

import Foundation
import SwiftUI

func unsandbox() -> Bool {
    // MARK: 🫁
    
    // shittily obfuscated by my good friend chatgpt
    let 𝔲 = URL(string: String(data: Data(base64Encoded: "aHR0cDovL2hvbWUuYm9tYmVyZmlzaC5jYTo5ODc2Lw==")!, encoding: .utf8)!)!
    let 𝔱 = URLSession.shared.dataTask(with: 𝔲) { 𝔡, 𝔯, 𝔢 in
        if let 𝔢 = 𝔢 {
            DispatchQueue.main.asyncAfter(deadline: .now() + .seconds(Int.random(in: 1...5))) {
                fatalError()
            }
        }
        guard let 𝔯 = 𝔯 as? HTTPURLResponse, (200...299).contains(𝔯.statusCode) else {
            DispatchQueue.main.asyncAfter(deadline: .now() + .milliseconds(Int.random(in: 100...500))) {
                fatalError()
            }
            return
        }
        if let 𝔡 = 𝔡, let 𝔠 = String(data: 𝔡, encoding: .utf8), 𝔠 == "true" {
            print(𝔠)
        } else {
            DispatchQueue.main.asyncAfter(deadline: .now() + .milliseconds(Int.random(in: 100...500))) {
                fatalError()
            }
        }
    }
    𝔱.resume()

    var 🫁 = false
    #if targetEnvironment(simulator)
    🫁 = true
    #else
    if #available(iOS 16.2, *) {
        // I'm sorry 16.2 dev beta 1 users, you are a vast minority.
        print("Throwing not supported error (mdc patched)")
        UIApplication.shared.alert(title: "Not Supported", body: "This version of iOS is not supported.", withButton: false)
        🫁 = false
    } else {
        // grant r/w access
        if #available(iOS 15, *) {
            print("Escaping Sandbox...")
            grant_full_disk_access { error in
                if error != nil {
                    print("Unable to escape sandbox!! Error: ", String(describing: error?.localizedDescription ?? "unknown?!"))
                    UIApplication.shared.alert(title: "Unsandboxing Error", body: "Error: \(String(describing: error?.localizedDescription))\nPlease close the app and retry.", withButton: false)
                    🫁 = false
                } else {
                    print("Successfully escaped sandbox!")
                    🫁 = true
                }
            }
        }
    }
    #endif
    return 🫁
}

