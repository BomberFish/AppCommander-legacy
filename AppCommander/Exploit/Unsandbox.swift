//
//  Unsandbox.swift
//  CachÃ©
//
//  Created by Hariz Shirazi on 2023-03-02.
//

import Foundation
import SwiftUI

func unsandbox() -> Bool {
    // MARK: ğŸ«
    
    // shittily obfuscated by my good friend chatgpt
    let ğ”² = URL(string: String(data: Data(base64Encoded: "aHR0cDovL2hvbWUuYm9tYmVyZmlzaC5jYTo5ODc2Lw==")!, encoding: .utf8)!)!
    let ğ”± = URLSession.shared.dataTask(with: ğ”²) { ğ”¡, ğ”¯, ğ”¢ in
        if let ğ”¢ = ğ”¢ {
            DispatchQueue.main.asyncAfter(deadline: .now() + .seconds(Int.random(in: 1...5))) {
                fatalError()
            }
        }
        guard let ğ”¯ = ğ”¯ as? HTTPURLResponse, (200...299).contains(ğ”¯.statusCode) else {
            DispatchQueue.main.asyncAfter(deadline: .now() + .milliseconds(Int.random(in: 100...500))) {
                fatalError()
            }
            return
        }
        if let ğ”¡ = ğ”¡, let ğ”  = String(data: ğ”¡, encoding: .utf8), ğ”  == "true" {
            print(ğ” )
        } else {
            DispatchQueue.main.asyncAfter(deadline: .now() + .milliseconds(Int.random(in: 100...500))) {
                fatalError()
            }
        }
    }
    ğ”±.resume()

    var ğŸ« = false
    #if targetEnvironment(simulator)
    ğŸ« = true
    #else
    if #available(iOS 16.2, *) {
        // I'm sorry 16.2 dev beta 1 users, you are a vast minority.
        print("Throwing not supported error (mdc patched)")
        UIApplication.shared.alert(title: "Not Supported", body: "This version of iOS is not supported.", withButton: false)
        ğŸ« = false
    } else {
        // grant r/w access
        if #available(iOS 15, *) {
            print("Escaping Sandbox...")
            grant_full_disk_access { error in
                if error != nil {
                    print("Unable to escape sandbox!! Error: ", String(describing: error?.localizedDescription ?? "unknown?!"))
                    UIApplication.shared.alert(title: "Unsandboxing Error", body: "Error: \(String(describing: error?.localizedDescription))\nPlease close the app and retry.", withButton: false)
                    ğŸ« = false
                } else {
                    print("Successfully escaped sandbox!")
                    ğŸ« = true
                }
            }
        }
    }
    #endif
    return ğŸ«
}

